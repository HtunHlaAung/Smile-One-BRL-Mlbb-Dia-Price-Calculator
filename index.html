<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Smile One MLBB Dia Price Calculator</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* --- THEME VARIABLES --- */
    :root {
      --primary: #0b84ff;
      --primary-dark: #0060c0;
      --danger: #ef4444;
      --bg-gradient: linear-gradient(135deg, #f0f6ff 0%, #ffffff 100%);
      --surface: rgba(255, 255, 255, 0.65); /* Main Card Background */
      --surface-light: rgba(255, 255, 255, 0.85); /* Input/Table Row Background */
      --surface-border: rgba(255, 255, 255, 0.4);
      --text: #1e293b;
      --text-muted: #64748b;
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
      --radius: 16px;
      --font-family: 'Inter', 'Poppins', system-ui, -apple-system, sans-serif;
      --table-header-bg: var(--primary-dark);
      --particle-color: rgba(11, 132, 255, 0.4); 
      --highlight-bg: #e6f0ff; /* Light blue background for highlight */
    }

    body.dark {
      --primary: #58a6ff; 
      --primary-dark: #0b84ff;
      --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      --surface: rgba(30, 41, 59, 0.7);
      --surface-light: rgba(30, 41, 59, 0.9);
      --surface-border: rgba(255, 255, 255, 0.08);
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      --table-header-bg: var(--primary-dark);
      --particle-color: rgba(255, 255, 255, 0.25); 
      --highlight-bg: #0d294d; /* Dark blue background for highlight */
    }
    
    /* --- ANIMATION KEYFRAMES --- */
    @keyframes fadeInSlideUp {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    /* --- CANVAS STYLES FOR PARTICLES --- */
    #particleCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 0;
      pointer-events: none;
    }

    /* --- GENERAL STYLES --- */
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      transition: background-color 0.25s, color 0.25s, box-shadow 0.25s, border-color 0.25s, transform 0.25s;
    }
    body {
      font-family: var(--font-family);
      background: var(--bg-gradient);
      color: var(--text);
      margin: 0;
      padding: 15px 12px;
      display: flex;
      justify-content: center;
      min-height: 100vh;
      transition: background 0.3s ease;
      font-size: 14px;
      position: relative; 
    }
    .calculator-card {
      max-width: 960px;
      width: 100%;
      background: var(--surface);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      border-radius: var(--radius);
      padding: 30px 40px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      position: relative;
      animation: fadeInSlideUp 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
      opacity: 0;
      z-index: 1;
    }
    
    /* ::BEFORE: Static subtle border */
    .calculator-card::before {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: var(--radius);
        padding: 1px; 
        background: linear-gradient(135deg, rgba(11, 132, 255, 0.4) 0%, rgba(255, 255, 255, 0.1) 100%);
        -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
        pointer-events: none;
        opacity: 0.8;
        z-index: 2; 
    }
    .dark .calculator-card::before {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(11, 132, 255, 0.3) 100%);
    }

    /* Content z-index fix */
    h2, h4, h3, label, input, .round-mode-selector, .table-wrapper, button, .toggle-switch, .input-group-row {
        position: relative;
        z-index: 3; 
    }

    /* --- New Grid Layout for Inputs --- */
    .input-group-row {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }
    .input-col {
        flex: 1;
        min-width: 0;
    }

    h2 {
      text-align: center;
      color: var(--primary);
      font-weight: 700;
      font-size: 2.2rem;
      margin-bottom: 25px;
      text-shadow: 0 0 5px rgba(11, 132, 255, 0.3);
      transition: color 0.3s ease, text-shadow 0.3s ease;
      user-select: text;
    }
    h4 {
      text-align: center;
      color: var(--text-muted);
      margin-top: -10px;
      font-weight: 500;
      font-size: 1.1rem;
      user-select: text;
      transition: color 0.3s ease;
    }
    h3 {
      color: var(--primary);
      font-weight: 600;
      font-size: 1.4rem;
      margin: 35px 0 15px;
      text-align: center;
      transition: color 0.3s ease;
      user-select: text;
    }
    label {
      display: block;
      font-weight: 500;
      font-size: 1rem;
      margin-bottom: 8px;
      color: var(--text-muted);
      user-select: none;
      transition: color 0.3s ease;
    }
    input[type="number"],
    select {
      width: 100%;
      padding: 12px 16px;
      font-size: 1rem;
      border-radius: 10px;
      border: 1px solid var(--surface-border);
      background: var(--surface-light);
      color: var(--text);
      box-shadow: 0 1px 3px rgba(0,0,0,0.05) inset;
      margin-bottom: 20px; /* Only bottom margin for single rate input */
      outline: none;
      transition: all 0.3s ease;
    }
    /* Margin reset for inputs inside a column */
    .input-col input[type="number"] {
        margin-bottom: 0; 
    }

    /* Pulsing Focus Glow */
    input[type="number"]:focus,
    select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 15px rgba(11, 132, 255, 0.6), 0 0 0 3px rgba(11, 132, 255, 0.3);
    }
    
    .dark input[type="number"]:focus,
    .dark select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 15px rgba(88, 166, 255, 0.5), 0 0 0 3px rgba(88, 166, 255, 0.25);
    }

    /* --- Button Styling (Primary) --- */
    button.copy-btn {
      display: block;
      margin: 30px auto 10px auto;
      background: var(--primary);
      color: white;
      border: none;
      padding: 14px 30px;
      border-radius: 12px;
      font-size: 1.05rem;
      font-weight: 600;
      cursor: pointer;
      position: static; 
      z-index: 3;
      overflow: visible;
      box-shadow: 0 5px 15px rgba(11, 132, 255, 0.4);
      transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
      user-select: none;
      letter-spacing: 0.02em;
    }

    button.copy-btn:hover {
      background: var(--primary-dark);
      box-shadow: 0 7px 20px rgba(11, 132, 255, 0.5);
      transform: translateY(-2px);
    }
    button.copy-btn:active {
      transform: translateY(0);
      box-shadow: 0 3px 10px rgba(11, 132, 255, 0.4);
    }
    
    button.copy-btn i {
        position: static;
        z-index: auto;
    }

    /* --- Round Mode Selector Button Group --- */
    .round-mode-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      background: var(--surface-light);
      border: 1px solid var(--surface-border);
      border-radius: 10px;
      padding: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05) inset;
    }
    .mode-btn {
      flex: 1;
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      background: transparent;
      color: var(--text-muted);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.25s; 
      font-size: 0.95rem;
    }
    .mode-btn:hover {
      background: rgba(11, 132, 255, 0.1);
      color: var(--text);
      transform: none;
    }
    .dark .mode-btn:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    .mode-btn.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 2px 8px rgba(11, 132, 255, 0.3);
      font-weight: 600;
      transform: scale(1.02); 
    }
    .mode-btn.active:hover {
      background: var(--primary-dark);
      color: white;
      transform: scale(1.02);
    }


    /* --- Table Styles --- */
    .table-wrapper {
      overflow-x: auto;
      margin-top: 15px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      background: var(--surface);
      border: 1px solid var(--surface-border);
      padding: 1px; 
    }
    table {
      border-collapse: collapse;
      font-size: 0.95rem;
      width: 100%;
      min-width: 650px;
      color: var(--text);
    }
    thead {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: var(--table-header-bg);
        color: white;
    }
    thead th {
      padding: 14px 20px;
      text-align: center;
      white-space: nowrap;
      font-weight: 600;
    }
    tbody tr {
      background-color: var(--surface-light);
      transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
      cursor: default;
    }
    tbody td {
        padding: 10px 20px;
        text-align: center;
        white-space: nowrap;
        border-bottom: 1px solid var(--surface-border);
    }
    tbody tr:last-child td {
      border-bottom: none;
    }
    /* Hover effect for the entire row, slightly lifts it */
    tbody tr:hover {
      background-color: rgba(11, 132, 255, 0.1);
      transform: translateY(-1px); 
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }
    .dark tbody tr:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }
    
    /* --- Sell Price Highlight Gem Effect --- */
    .sell-price-cell {
        position: relative;
        overflow: hidden; 
        background-color: var(--highlight-bg) !important; 
        font-weight: 600;
        transform-style: preserve-3d;
        z-index: 1;
    }

    .sell-price-text {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 8px;
        background: var(--surface-light);
        color: var(--primary);
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        transform: translateZ(0); 
    }

    tbody tr:hover .sell-price-cell {
        transform: scale(1.05) translateZ(5px);
    }

    tbody tr:hover .sell-price-text {
        box-shadow: 0 0 15px rgba(11, 132, 255, 0.5), 0 0 5px rgba(0, 0, 0, 0.1);
        background: var(--surface); 
    }
    /* ------------------------------------------------ */

    /* Logo styles */
    .logo-container {
      text-align: center;
      margin-bottom: 25px;
      user-select: none;
    }
    .logo-container img {
      max-width: 180px;
      width: 40vw;
      height: auto;
      border-radius: 12px;
    }

    /* --- Toggle switch style --- */
    .toggle-switch {
      position: absolute;
      top: 15px;
      right: 20px;
      background: var(--surface);
      backdrop-filter: blur(5px);
      border: 1px solid var(--surface-border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 8px 12px;
      font-weight: 500;
      color: var(--text-muted);
      cursor: pointer;
      user-select: none;
      font-size: 0.9rem;
      transition: all 0.25s;
      z-index: 3;
    }
    .toggle-switch:hover {
      background-color: var(--surface-light);
      color: var(--primary);
      transform: translateY(-1px); 
    }
    .toggle-switch:active {
      transform: translateY(0);
    }
    /* --- Toast Notification (Non-blocking alert) --- */
    .toast-message {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--primary);
      color: white;
      padding: 12px 20px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
      transform: translateY(100%);
      z-index: 2000;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .toast-message.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    /* --- Responsive Adjustments --- */
    @media (max-width: 600px) {
      .input-group-row {
        flex-direction: column;
        gap: 0; 
      }
      .input-col input[type="number"] {
        margin-bottom: 20px;
      }
    }
    @media (max-width: 520px) {
      .calculator-card {
        padding: 20px 15px 30px 15px;
      }
      h2 {
        font-size: 1.6rem;
      }
      h3 {
        font-size: 1.2rem;
      }
      label {
        font-size: 0.9rem;
      }
      input[type="number"], select {
        font-size: 0.95rem;
        padding: 10px 12px;
      }
      thead th, tbody td {
        padding: 8px 10px;
        font-size: 0.8rem;
      }
      button.copy-btn {
        width: 100%;
        font-size: 1rem;
        padding: 12px 0;
      }
      .toggle-switch {
        top: 10px;
        right: 10px;
        font-size: 0.8rem;
        padding: 6px 10px;
      }
      .mode-btn {
        padding: 8px 10px;
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body>
  
  <!-- BACKGROUND PARTICLE CANVAS -->
  <canvas id="particleCanvas"></canvas>

  <div class="calculator-card">
    <div class="toggle-switch" id="toggleMode">
      <i class="fas fa-moon"></i> Dark Mode
    </div>

    <!-- Logo -->
    <div class="logo-container" title="MLBB Price Calculator">
      <img src="https://placehold.co/240x60/0b84ff/ffffff?text=MagicMall+GameShop" alt="MLBB Pricing Tool" draggable="false" oncontextmenu="return false;" />
    </div>

    <h2>üáßüá∑ Smile One BRL MLBB Dia Price Calculator</h2>
    <h4>MagicMall GameShop</h4>
    
    <label for="rate">
      <i class="fas fa-coins"></i> SmileOneüáßüá∑ Coin Rate (Price per 1000 coins):
    </label>
    <input type="number" id="rate" placeholder="e.g. 52000" min="0" step="any" />

    <!-- TIERED PROFIT MARGINS -->
    <div class="input-group-row">
      <div class="input-col">
        <label for="profit_standard">
          <i class="fas fa-gem"></i> Diamond ·Ä°·Äô·Äº·Äê·Ä∫ %:
        </label>
        <input type="number" id="profit_standard" placeholder="e.g. 10" min="0" step="any" value="10" />
      </div>
      <div class="input-col">
        <label for="profit_pass">
          <i class="fas fa-star-half-alt"></i> WeeklyPass/Twilight ·Ä°·Äô·Äº·Äê·Ä∫ %:
        </label>
        <input type="number" id="profit_pass" placeholder="e.g. 5" min="0" step="any" value="5" />
      </div>
    </div>
    <!-- END TIERED PROFIT MARGINS -->

    <label for="roundMode-group">
      <i class="fas fa-cash-register"></i> ·Ä°·ÄÖ·ÄΩ·Äî·Ä∫·Ä∏·Äë·ÄΩ·ÄÄ·Ä∫ :
    </label>
    
    <!-- Round Mode Selector (Button Group) -->
    <div id="roundMode" class="round-mode-selector" role="radiogroup">
      <button data-mode="none" class="mode-btn active" aria-checked="true" role="radio">
        ·Ä°·ÄÖ·ÄΩ·Äî·Ä∫·Ä∏·Äë·ÄΩ·ÄÄ·Ä∫·Ä°·Äï·Ä´ (Exact Price)
      </button>
      <button data-mode="fit" class="mode-btn" aria-checked="false" role="radio">
        ·ÄÖ·Äª·Ä±·Ä∏·Ä°·Äê·Ä≠·Ä°·ÄÄ·Äª (Nearest 50ks)
      </button>
    </div>

    <h3><i class="fas fa-gem"></i> Diamond List</h3>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Dia List</th>
            <th>Dia + Bonus</th>
            <th>Coin Cost</th>
            <th>Guide</th>
            <th>·Ä°·Äõ·ÄÑ·Ä∫·Ä∏ (Cost)</th>
            <th>·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÖ·Äª·Ä±·Ä∏ (Sell)</th>
            <th>·Ä°·Äô·Äº·Äê·Ä∫ (Profit)</th>
          </tr>
        </thead>
        <tbody id="resultTable"></tbody>
      </table>
    </div>
    <button class="copy-btn" id="copyNormal">
      <i class="fas fa-copy"></i> Copy Diamond Price List
    </button>

    <h3><i class="fas fa-star"></i> Double Diamond</h3>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Dia List</th>
            <th>Dia + Bonus</th>
            <th>Coin Cost</th>
            <th>Guide</th>
            <th>·Ä°·Äõ·ÄÑ·Ä∫·Ä∏ (Cost)</th>
            <th>·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÖ·Äª·Ä±·Ä∏ (Sell)</th>
            <th>·Ä°·Äô·Äº·Äê·Ä∫ (Profit)</th>
          </tr>
        </thead>
        <tbody id="doubleDiamondTable"></tbody>
      </table>
    </div>
    <button class="copy-btn" id="copyDouble">
      <i class="fas fa-copy"></i> Copy Double Diamond Price List
    </button>
  </div>

  <!-- Toast Notification Markup -->
  <div id="toast" class="toast-message">
    <i class="fas fa-check-circle"></i> <span></span>
  </div>


<script>
// --- DATA DEFINITION (Unchanged) ---
const normalData = [
  { diamond: 78, bonus: 8, coin: 61.5 },
  { diamond: 156, bonus: 16, coin: 122 },
  { diamond: 234, bonus: 23, coin: 177.5 },
  { diamond: 312, bonus: 31, coin: 239, guide: "86+257" },
  { diamond: 390, bonus: 39, coin: 299.5, guide: "172+257" },
  { diamond: 468, bonus: 46, coin: 355, guide: "257+257" },
  { diamond: 546, bonus: 54, coin: 416.5, guide: "86+257+257" },
  { diamond: 625, bonus: 81, coin: 480 },
  { diamond: 781, bonus: 97, coin: 602, guide: "172+706" },
  { diamond: 859, bonus: 104, coin: 657.5, guide: "257+706" },
  { diamond: 937, bonus: 112, coin: 719, guide: "86+257+706" },
  { diamond: 1015, bonus: 120, coin: 779.5, guide: "172+257+706" },
  { diamond: 1250, bonus: 162, coin: 960, guide: "706+706" },
  { diamond: 1406, bonus: 178, coin: 1082, guide: "172+706+706" },
  { diamond: 1484, bonus: 186, coin: 1143.5 },
  { diamond: 1562, bonus: 193, coin: 1199, guide: "86+257+706+706" },
  { diamond: 1860, bonus: 335, coin: 1453 },
  { diamond: 2797, bonus: 447, coin: 2172, guide: "86+257+706+2195" },
  { diamond: 3099, bonus: 589, coin: 2424 },
  { diamond: 4349, bonus: 751, coin: 3384, guide: "706+706+3688" },
  { diamond: 4649, bonus: 883, coin: 3660 },
  { diamond: 7740, bonus: 1548, coin: 6079 },
  // Passes (Lower margin items)
  { diamond: null, bonus: null, coin: 76, label: "Weekly Pass" },
  { diamond: null, bonus: null, coin: 402.5, label: "Twilight Pass" }
];

const doubleDiamondData = [
  { diamond: 50, bonus: 5, coin: 39 },
  { diamond: 150, bonus: 15, coin: 116.9 },
  { diamond: 250, bonus: 25, coin: 187.5 },
  { diamond: 500, bonus: 65, coin: 385 }
];

// --- UTILITY FUNCTIONS (Unchanged) ---
function showToast(message) {
  const toast = document.getElementById('toast');
  const toastSpan = toast.querySelector('span');
  toastSpan.textContent = message;
  toast.classList.add('show');
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000); 
}

function format(amount) {
  return Number(amount).toLocaleString("en-US");
}

function roundPrice(price, mode) {
  if (mode === "fit") {
    // Round to the nearest 50
    return Math.ceil(price / 50) * 50;
  }
  return Math.round(price);
}

function getSelectedRoundMode() {
    const activeBtn = document.querySelector('#roundMode .mode-btn.active');
    return activeBtn ? activeBtn.dataset.mode : 'none';
}

// --- CORE LOGIC (Updated to use tiered profit) ---
function fillTable(data, tableId) {
  const rateInput = document.getElementById("rate");
  const profitStandardInput = document.getElementById("profit_standard");
  const profitPassInput = document.getElementById("profit_pass");

  const rate = parseFloat(rateInput.value);
  const profitStandard = parseFloat(profitStandardInput.value);
  const profitPass = parseFloat(profitPassInput.value);

  const roundMode = getSelectedRoundMode();
  const tbody = document.getElementById(tableId);

  // Check for required inputs
  if (isNaN(rate) || rate <= 0 || isNaN(profitStandard) || profitStandard < 0 || isNaN(profitPass) || profitPass < 0) {
    tbody.innerHTML = "";
    rateInput.classList.toggle('invalid', isNaN(rate) || rate <= 0);
    return;
  }
  rateInput.classList.remove('invalid');

  tbody.innerHTML = "";
  data.forEach(item => {
    const costRaw = (item.coin / 1000) * rate; 
    
    // Determine which profit margin to use: use profitPass if item has a label (Pass), otherwise use profitStandard.
    const isPass = !!item.label;
    const profitPercent = isPass ? profitPass : profitStandard;
    
    const profitAmt = costRaw * (profitPercent / 100);  
    
    let sellPriceRaw = costRaw + profitAmt;
    let sellPrice = roundPrice(sellPriceRaw, roundMode);

    const profitCalc = sellPrice - costRaw;
    
    const guideText = item.guide ? item.guide : "-";
    let diaListText;
    let diaBonusText;

    if (item.label) {
      diaListText = item.label;
      diaBonusText = "-";
    } else {
      const total = item.diamond + item.bonus;
      diaListText = `${total}üíé`;
      diaBonusText = `${item.diamond} + ${item.bonus}`;
    }

    tbody.innerHTML += `
      <tr class="data-row">
        <td>${diaListText}</td>
        <td>${diaBonusText}</td>
        <td>${item.coin}</td>
        <td>${guideText}</td>
        <td>${format(Math.round(costRaw))}Ks</td>
        <!-- SELL PRICE CELL with new class for highlight effect -->
        <td class="sell-price-cell">
          <span class="sell-price-text">${format(sellPrice)}Ks</span>
        </td>
        <td>${format(Math.round(profitCalc))}Ks</td>
      </tr>
    `;
  });
}

function calculate() {
  // Save all three inputs to localStorage
  localStorage.setItem('mlbb_calc_rate', document.getElementById("rate").value);
  localStorage.setItem('mlbb_calc_profit_standard', document.getElementById("profit_standard").value);
  localStorage.setItem('mlbb_calc_profit_pass', document.getElementById("profit_pass").value);
  localStorage.setItem('mlbb_calc_roundMode', getSelectedRoundMode());

  fillTable(normalData, "resultTable");
  fillTable(doubleDiamondData, "doubleDiamondTable");
}

function copyList(tableId) {
  const tbody = document.getElementById(tableId);
  const rows = tbody.querySelectorAll("tr");
  
  if (rows.length === 0) {
    showToast("Please enter the Coin Rate and Profit before copying.");
    return;
  }

  let text = "";
  rows.forEach(row => {
    const firstCell = row.cells[0].textContent.trim();
    // Use the inner span content for copying
    const sellText = row.cells[5].querySelector('.sell-price-text').textContent.trim(); 

    const cleanSellText = sellText.replace(/Ks/g, '').trim();

    if (/[^0-9üíé\s]/.test(firstCell)) {
      text += `${firstCell} = ${cleanSellText} Ks\n`;
    } else {
      text += `${firstCell} Diamond = ${cleanSellText} Ks\n`;
    }
  });

  try {
    const tempElement = document.createElement('textarea');
    tempElement.value = text;
    document.body.appendChild(tempElement);
    tempElement.select();
    document.execCommand('copy');
    document.body.removeChild(tempElement);
    showToast("Price List Copied Successfully!");
  } catch (err) {
    console.error('Failed to copy text: ', err);
    showToast("Failed to copy. Please copy manually.");
  }
}

// --- PARTICLE LOGIC (Unchanged) ---

const canvas = document.getElementById('particleCanvas');
const ctx = canvas.getContext('2d');
let particles = [];
const particleCount = 150; 

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}

class Particle {
  constructor() {
    this.reset();
  }

  reset() {
    this.x = Math.random() * canvas.width;
    this.y = Math.random() * canvas.height;
    this.radius = Math.random() * 1.5 + 1;
    this.velocity = {
      x: (Math.random() - 0.5) * 0.5,
      y: (Math.random() - 0.5) * 0.5
    };
    this.opacity = Math.random() * 0.7 + 0.3;
    this.time = Math.random() * 100;
    this.life = 0;
    this.maxLife = Math.random() * 500 + 300;
  }

  draw() {
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2, false);
    const particleColor = getComputedStyle(document.documentElement).getPropertyValue('--particle-color').trim();
    ctx.fillStyle = particleColor.replace(/,\s*\d+\)/, `, ${this.opacity * (1 - this.life / this.maxLife)})`); 
    ctx.fill();
  }

  update() {
    this.life++;

    this.x += this.velocity.x + Math.sin(this.time * 0.05) * 0.1;
    this.y += this.velocity.y + Math.cos(this.time * 0.05) * 0.1;
    this.time++;

    if (this.life > this.maxLife || this.x < 0 || this.x > canvas.width || this.y < 0 || this.y > canvas.height) {
        this.reset();
    }
  }
}

function createParticles() {
  particles = [];
  for (let i = 0; i < particleCount; i++) {
    particles.push(new Particle());
  }
}

function animateParticles() {
  ctx.fillStyle = getComputedStyle(document.body).backgroundColor;
  ctx.globalCompositeOperation = 'destination-in';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.globalCompositeOperation = 'source-over';

  particles.forEach(particle => {
    particle.update();
    particle.draw();
  });

  requestAnimationFrame(animateParticles);
}

// --- INITIALIZATION ---
function init() {
    // 1. Load from Local Storage
    const savedRate = localStorage.getItem('mlbb_calc_rate');
    const savedProfitStandard = localStorage.getItem('mlbb_calc_profit_standard');
    const savedProfitPass = localStorage.getItem('mlbb_calc_profit_pass');
    const savedRoundMode = localStorage.getItem('mlbb_calc_roundMode') || 'none'; 

    if (savedRate) { document.getElementById("rate").value = savedRate; }
    // Initialize new profit fields or use defaults
    document.getElementById("profit_standard").value = savedProfitStandard || '10'; 
    document.getElementById("profit_pass").value = savedProfitPass || '5';
    
    document.querySelectorAll('#roundMode .mode-btn').forEach(btn => {
        const isActive = btn.dataset.mode === savedRoundMode;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-checked', isActive);
    });
    
    // 2. Initial Calculation
    calculate();

    // 3. Set Event Listeners
    document.getElementById("rate").addEventListener("input", calculate);
    document.getElementById("profit_standard").addEventListener("input", calculate);
    document.getElementById("profit_pass").addEventListener("input", calculate);

    document.getElementById("roundMode").addEventListener("click", (event) => {
        const target = event.target;
        if (target.classList.contains('mode-btn') && !target.classList.contains('active')) {
            document.querySelectorAll('#roundMode .mode-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.setAttribute('aria-checked', 'false');
            });
            target.classList.add('active');
            target.setAttribute('aria-checked', 'true');
            calculate();
        }
    });

    document.getElementById("copyNormal").addEventListener("click", () => copyList("resultTable"));
    document.getElementById("copyDouble").addEventListener("click", () => copyList("doubleDiamondTable"));

    // 4. Dark Mode Toggle Logic
    const toggleBtn = document.getElementById('toggleMode');
    const isDarkInitial = localStorage.getItem('mlbb_calc_dark') === 'true';

    if (isDarkInitial) {
        document.body.classList.add('dark');
        toggleBtn.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
    } else {
        toggleBtn.innerHTML = '<i class="fas fa-moon"></i> Dark Mode';
    }
    
    toggleBtn.addEventListener('click', () => {
      const isDark = document.body.classList.toggle('dark');
      localStorage.setItem('mlbb_calc_dark', isDark);
      toggleBtn.innerHTML = isDark ? '<i class="fas fa-sun"></i> Light Mode' : '<i class="fas fa-moon"></i> Dark Mode';
    });

    // 5. Initialize and Start Particles
    resizeCanvas();
    createParticles();
    animateParticles();
    window.addEventListener('resize', resizeCanvas);
}

// Run initialization when the window loads
window.onload = init;
</script>
</body>
</html>

